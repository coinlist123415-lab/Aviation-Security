<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Aviation Security LMS</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 15px;
        }
        .close:hover {
            color: black;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-actions {
            margin-top: 20px;
            text-align: right;
        }
        .user-credentials {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #27ae60;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">
                <h1>✈️ LMS Admin Panel</h1>
            </div>
            <div class="user-info">
                <span id="adminName">Admin User</span>
                <a href="index.html" class="btn btn-secondary">User Dashboard</a>
                <button class="btn btn-primary" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>
    
    <nav>
        <div class="container">
            <ul class="nav-tabs">
                <li class="active" onclick="switchAdminTab('dashboard')">Admin Dashboard</li>
                <li onclick="switchAdminTab('users')">User Management</li>
                <li onclick="switchAdminTab('courses')">Course Management</li>
                <li onclick="switchAdminTab('tests')">Test Management</li>
            </ul>
        </div>
    </nav>
    
    <main class="container">
        <!-- Admin Dashboard -->
        <div id="dashboardManagement" class="tab-content active">
            <h2>Admin Dashboard</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="number" id="totalUsers">0</div>
                    <div class="label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalCourses">0</div>
                    <div class="label">Active Courses</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalTests">0</div>
                    <div class="label">Total Tests</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="activeUsers">0</div>
                    <div class="label">Active Users</div>
                </div>
            </div>
            
            <div class="admin-quick-actions">
                <h3>Quick Actions</h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showUserModal()">Add New User</button>
                    <button class="btn btn-primary" onclick="showCourseModal()">Create Course</button>
                    <button class="btn btn-primary" onclick="showTestModal()">Create Test</button>
                </div>
            </div>

            <h3>Recent Activity</h3>
            <div id="recentActivity">
                <!-- Recent activity will be loaded here -->
            </div>
        </div>
        
        <!-- User Management -->
        <div id="usersManagement" class="tab-content">
            <h2>User Management</h2>
            <div class="admin-toolbar">
                <button class="btn btn-primary" onclick="showUserModal()">Add New User</button>
                <input type="text" id="userSearch" placeholder="Search users..." onkeyup="searchUsers()">
            </div>
            <div class="admin-table">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Course Management -->
        <div id="coursesManagement" class="tab-content">
            <h2>Course Management</h2>
            <div class="admin-toolbar">
                <button class="btn btn-primary" onclick="showCourseModal()">Create New Course</button>
            </div>
            <div class="course-grid" id="coursesTable">
                <!-- Courses will be loaded here -->
            </div>
        </div>
        
        <!-- Test Management -->
        <div id="testsManagement" class="tab-content">
            <h2>Test Management</h2>
            <div class="admin-toolbar">
                <button class="btn btn-primary" onclick="showTestModal()">Create New Test</button>
            </div>
            <div class="admin-table">
                <table>
                    <thead>
                        <tr>
                            <th>Test Name</th>
                            <th>Course</th>
                            <th>Questions</th>
                            <th>Passing Score</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="testsTable">
                        <!-- Tests will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('userModal')">&times;</span>
            <h3 id="userModalTitle">Add New User</h3>
            
            <div id="userCredentials" class="user-credentials" style="display: none;">
                <h4>✅ User Created Successfully!</h4>
                <p><strong>Username:</strong> <span id="createdUsername"></span></p>
                <p><strong>Password:</strong> <span id="createdPassword"></span></p>
                <p><strong>Share these credentials with the user</strong></p>
            </div>
            
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>Username: *</label>
                    <input type="text" id="username" required placeholder="Choose a username">
                </div>
                <div class="form-group">
                    <label>Full Name: *</label>
                    <input type="text" id="fullName" required placeholder="Enter full name">
                </div>
                <div class="form-group">
                    <label>Email: *</label>
                    <input type="email" id="userEmail" required placeholder="Enter email address">
                </div>
                <div class="form-group">
                    <label>Password: *</label>
                    <input type="text" id="userPassword" required placeholder="Enter password">
                    <small>User will login with this password</small>
                </div>
                <div class="form-group">
                    <label>Role: *</label>
                    <select id="userRole" required>
                        <option value="student">Student/Trainee</option>
                        <option value="instructor">Instructor</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Department:</label>
                    <input type="text" id="userDepartment" placeholder="Department (optional)">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Save User</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Course Modal -->
    <div id="courseModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('courseModal')">&times;</span>
            <h3>Create New Course</h3>
            <form id="courseForm">
                <div class="form-group">
                    <label>Course Name: *</label>
                    <input type="text" id="courseName" required placeholder="Enter course name">
                </div>
                <div class="form-group">
                    <label>Description: *</label>
                    <textarea id="courseDescription" required placeholder="Enter course description"></textarea>
                </div>
                <div class="form-group">
                    <label>Duration (hours): *</label>
                    <input type="number" id="courseDuration" required min="1" value="4">
                </div>
                <div class="form-group">
                    <label>Category: *</label>
                    <select id="courseCategory" required>
                        <option value="screening">Security Screening</option>
                        <option value="behavioral">Behavioral Detection</option>
                        <option value="emergency">Emergency Response</option>
                        <option value="technical">Technical Training</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Video URL:</label>
                    <input type="url" id="courseVideo" placeholder="https://youtube.com/embed/...">
                    <small>Paste YouTube embed URL or direct video link</small>
                </div>
                <div class="form-group">
                    <label>Course Content:</label>
                    <textarea id="courseContent" placeholder="Detailed course content..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="saveCourse()">Save Course</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('courseModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Check admin access
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser || currentUser.role !== 'admin') {
            alert('Access denied! Admin privileges required.');
            window.location.href = 'login.html';
        } else {
            document.getElementById('adminName').textContent = currentUser.name;
        }

        // Load data
        let users = JSON.parse(localStorage.getItem('lms_users') || '[]');
        let courses = JSON.parse(localStorage.getItem('lms_courses') || '[]');
        let tests = JSON.parse(localStorage.getItem('lms_tests') || '[]');

        // Initialize admin panel
        function initializeAdminPanel() {
            loadDashboard();
            loadUsers();
            loadCourses();
            loadTests();
        }

        function loadDashboard() {
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalCourses').textContent = courses.length;
            document.getElementById('totalTests').textContent = tests.length;
            document.getElementById('activeUsers').textContent = users.filter(u => u.status === 'active').length;
        }

        // USER MANAGEMENT FUNCTIONS
        function loadUsers() {
            const usersTable = document.getElementById('usersTable');
            usersTable.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="role-badge ${user.role}">${user.role}</span></td>
                    <td><span class="status-badge ${user.status}">${user.status}</span></td>
                    <td>${new Date(user.created).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editUser(${user.id})">Edit</button>
                        ${user.username !== 'adminline' ? `
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Delete</button>
                            <button class="btn btn-warning btn-sm" onclick="toggleUserStatus(${user.id})">
                                ${user.status === 'active' ? 'Deactivate' : 'Activate'}
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function showUserModal() {
            document.getElementById('userCredentials').style.display = 'none';
            document.getElementById('userForm').reset();
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('userId').value = '';
            document.getElementById('userModal').style.display = 'block';
        }

        function saveUser() {
            const username = document.getElementById('username').value.trim();
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            const department = document.getElementById('userDepartment').value.trim();

            // Validate required fields
            if (!username || !fullName || !email || !password) {
                alert('Please fill in all required fields.');
                return;
            }

            // Check if username already exists
            if (users.find(u => u.username === username)) {
                alert('Username already exists. Please choose a different username.');
                return;
            }

            const newUser = {
                id: Math.max(0, ...users.map(u => u.id)) + 1,
                username: username,
                password: password,
                name: fullName,
                email: email,
                role: role,
                department: department || 'Security',
                status: 'active',
                created: new Date().toISOString()
            };

            users.push(newUser);
            localStorage.setItem('lms_users', JSON.stringify(users));

            // Show success message with credentials
            document.getElementById('createdUsername').textContent = username;
            document.getElementById('createdPassword').textContent = password;
            document.getElementById('userCredentials').style.display = 'block';

            // Reload data
            loadUsers();
            loadDashboard();

            console.log('New user created:', newUser);
            console.log('All users:', users);
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('fullName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userDepartment').value = user.department || '';
            document.getElementById('userPassword').placeholder = 'Leave blank to keep current password';
            
            document.getElementById('userCredentials').style.display = 'none';
            document.getElementById('userModal').style.display = 'block';
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                users = users.filter(u => u.id !== userId);
                localStorage.setItem('lms_users', JSON.stringify(users));
                loadUsers();
                loadDashboard();
                alert('User deleted successfully!');
            }
        }

        function toggleUserStatus(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                user.status = user.status === 'active' ? 'inactive' : 'active';
                localStorage.setItem('lms_users', JSON.stringify(users));
                loadUsers();
                alert(`User ${user.status === 'active' ? 'activated' : 'deactivated'} successfully!`);
            }
        }

        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const filteredUsers = users.filter(user => 
                user.username.toLowerCase().includes(searchTerm) ||
                user.name.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm)
            );
            
            const usersTable = document.getElementById('usersTable');
            usersTable.innerHTML = filteredUsers.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="role-badge ${user.role}">${user.role}</span></td>
                    <td><span class="status-badge ${user.status}">${user.status}</span></td>
                    <td>${new Date(user.created).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editUser(${user.id})">Edit</button>
                        ${user.username !== 'adminline' ? `
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Delete</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // COURSE MANAGEMENT FUNCTIONS
        function loadCourses() {
            const coursesTable = document.getElementById('coursesTable');
            coursesTable.innerHTML = courses.map(course => `
                <div class="course-card">
                    <div class="course-header">
                        <h4>${course.name}</h4>
                    </div>
                    <div class="course-body">
                        <p>${course.description}</p>
                        <p><strong>Duration:</strong> ${course.duration} hours</p>
                        <p><strong>Category:</strong> ${course.category}</p>
                        ${course.video ? `<p><strong>Video:</strong> Available</p>` : ''}
                    </div>
                    <div class="course-footer">
                        <button class="btn btn-secondary" onclick="editCourse(${course.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteCourse(${course.id})">Delete</button>
                        <button class="btn btn-primary" onclick="uploadVideo(${course.id})">Upload Video</button>
                    </div>
                </div>
            `).join('');
        }

        function showCourseModal() {
            document.getElementById('courseForm').reset();
            document.getElementById('courseModal').style.display = 'block';
        }

        function saveCourse() {
            const courseData = {
                name: document.getElementById('courseName').value,
                description: document.getElementById('courseDescription').value,
                duration: parseInt(document.getElementById('courseDuration').value),
                category: document.getElementById('courseCategory').value,
                video: document.getElementById('courseVideo').value,
                content: document.getElementById('courseContent').value,
                status: 'active',
                created: new Date().toISOString()
            };

            courseData.id = Math.max(0, ...courses.map(c => c.id)) + 1;
            courses.push(courseData);
            
            localStorage.setItem('lms_courses', JSON.stringify(courses));
            loadCourses();
            loadDashboard();
            closeModal('courseModal');
            alert('Course created successfully!');
        }

        function editCourse(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (course) {
                document.getElementById('courseName').value = course.name;
                document.getElementById('courseDescription').value = course.description;
                document.getElementById('courseDuration').value = course.duration;
                document.getElementById('courseCategory').value = course.category;
                document.getElementById('courseVideo').value = course.video || '';
                document.getElementById('courseContent').value = course.content || '';
                document.getElementById('courseModal').style.display = 'block';
            }
        }

        function deleteCourse(courseId) {
            if (confirm('Are you sure you want to delete this course?')) {
                courses = courses.filter(c => c.id !== courseId);
                localStorage.setItem('lms_courses', JSON.stringify(courses));
                loadCourses();
                loadDashboard();
                alert('Course deleted successfully!');
            }
        }

        function uploadVideo(courseId) {
            const videoUrl = prompt('Enter video URL (YouTube embed URL or direct link):');
            if (videoUrl) {
                const course = courses.find(c => c.id === courseId);
                course.video = videoUrl;
                localStorage.setItem('lms_courses', JSON.stringify(courses));
                loadCourses();
                alert('Video uploaded successfully!');
            }
        }

        // TEST MANAGEMENT FUNCTIONS
        function loadTests() {
            const testsTable = document.getElementById('testsTable');
            testsTable.innerHTML = tests.map(test => {
                const course = courses.find(c => c.id === test.courseId);
                return `
                    <tr>
                        <td>${test.name}</td>
                        <td>${course ? course.name : 'N/A'}</td>
                        <td>${test.questions ? test.questions.length : 0}</td>
                        <td>${test.passingScore}%</td>
                        <td><span class="status-badge ${test.status}">${test.status}</span></td>
                        <td>
                            <button class="btn btn-secondary btn-sm">Edit</button>
                            <button class="btn btn-danger btn-sm">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="6">No tests created yet.</td></tr>';
        }

        function showTestModal() {
            alert('Test creation feature will be implemented in the next version.');
        }

        // UTILITY FUNCTIONS
        function switchAdminTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.nav-tabs li').forEach(item => item.classList.remove('active'));
            
            document.getElementById(tabName + 'Management').style.display = 'block';
            event.target.classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        // Initialize on load
        window.addEventListener('load', initializeAdminPanel);
    </script>
</body>
</html>